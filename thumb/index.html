<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Miniaturas Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Bebas+Neue&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #007bff;
            --panel-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --border-color: #444;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header y Languages --- */
        .header-actions {
            display: flex;
            justify-content: flex-end;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 10px;
            gap: 10px;
        }
        .lang-btn {
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
        }
        .lang-btn.active { background: var(--accent-color); border-color: var(--accent-color); }

        h1 { margin-bottom: 20px; text-align: center; }

        /* --- Layout Principal --- */
        .main-container {
            display: flex;
            flex-direction: column; /* Previsualización arriba */
            gap: 25px;
            max-width: 1000px;
            width: 100%;
        }

        .panel {
            background-color: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        /* --- Previsualización (Ahora arriba) --- */
        .preview-panel { width: 100%; }
        .canvas-wrapper {
            width: 100%;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background-color: #000;
        }
        #previewCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* --- Controles --- */
        .controls-panel {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Dos columnas en escritorio */
            gap: 20px;
        }
        @media (max-width: 768px) { .controls-panel { grid-template-columns: 1fr; } }

        .control-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        
        label { font-weight: 600; color: var(--accent-color); font-size: 0.9rem; }
        
        /* Inputs y Selects */
        input[type="text"], textarea, select, input[type="file"] {
            width: 100%; padding: 10px; border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg); color: white;
            box-sizing: border-box; font-size: 1rem;
        }
        input[type="color"] {
             padding: 0; border: none; height: 38px; width: 100%; cursor: pointer;
        }
        textarea { resize: vertical; height: 70px; font-family: monospace; }

        /* Botones */
        button {
            padding: 12px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; transition: 0.2s; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; width: 100%; }
        .btn-success:hover { background-color: #1e7e34; }
        
        .divider { grid-column: 1 / -1; height: 1px; background-color: var(--border-color); margin: 10px 0; }
        .full-width { grid-column: 1 / -1; }

        /* Utilidades para la fila de controles */
        .flex-row-controls { display: flex; gap: 10px; }
        .flex-row-controls > div { flex: 1; }
    </style>
</head>
<body>

    <div class="header-actions">
        <button class="lang-btn active" onclick="setLanguage('es')">ES</button>
        <button class="lang-btn" onclick="setLanguage('en')">EN</button>
        <button class="lang-btn" onclick="setLanguage('de')">DE</button>
    </div>

    <h1 data-translate="mainTitle">Generador de Miniaturas Pro</h1>

    <div class="main-container">
        
        <div class="panel preview-panel">
            <div class="canvas-wrapper">
                <canvas id="previewCanvas" width="1280" height="720"></canvas>
            </div>
            <button id="downloadBtn" class="btn-success" style="margin-top: 15px;" data-translate="downloadBtn">Descargar Miniatura</button>
        </div>

        <div class="panel controls-panel">
            
            <div class="control-group full-width">
                <label data-translate="lblSelectTemplate">Seleccionar Plantilla</label>
                <select id="templateSelect">
                    <option value="template1.png">Template 1 (Default)</option>
                    <option value="template2.png">Template 2</option>
                    <option value="template3.png">Template 3</option>
                </select>
            </div>

            <div>
                <div class="control-group">
                    <label data-translate="lblTitle">1. Título Principal (Franja Inferior)</label>
                    <input type="text" id="titleText" placeholder="...">
                    <div class="flex-row-controls">
                        <select id="titleFont">
                            <option value="'Bebas Neue', cursive">Fuente A (Bebas Neue)</option>
                            <option value="'Anton', sans-serif">Fuente B (Anton)</option>
                            <option value="'Oswald', sans-serif">Fuente C (Oswald Bold)</option>
                        </select>
                         <input type="color" id="titleColor" value="#FFFFFF" style="width: 60px; flex:none;">
                    </div>
                </div>

                <div class="control-group">
                    <label data-translate="lblDesc">2. Descripción (Franja Media)</label>
                    <input type="text" id="descText" placeholder="...">
                     <div class="flex-row-controls">
                        <select id="descFont">
                             <option value="'Bebas Neue', cursive">Fuente A (Bebas Neue)</option>
                            <option value="'Anton', sans-serif" selected>Fuente B (Anton)</option>
                            <option value="'Oswald', sans-serif">Fuente C (Oswald Bold)</option>
                        </select>
                        <input type="color" id="descColor" value="#FFFFFF" style="width: 60px; flex:none;">
                    </div>
                </div>
            </div>

            <div>
                 <div class="control-group">
                    <label data-translate="lblBgUpload">Subir Fondo Propio</label>
                    <input type="file" id="bgUpload" accept="image/*">
                </div>
                
                <div class="divider"></div>
                
                <div class="control-group">
                    <label data-translate="lblGrokIdea">Generador de Prompt para Grok</label>
                    <input type="text" id="grokIdea" data-translate-ph="phGrokIdea" placeholder="Idea base (ej. Hacker en servidor...)">
                    
                    <div class="flex-row-controls" style="margin-top: 10px;">
                        <select id="grokStyle">
                            <option value="realistic, cinematic lighting, 8k">Estilo: Realista Cinemático</option>
                            <option value="cyberpunk, neon lights, futuristic">Estilo: Cyberpunk Neón</option>
                            <option value="dramatic, dark aesthetic, intense">Estilo: Dramático Oscuro</option>
                        </select>
                         <select id="grokRatio">
                            <option value="16:9 aspect ratio">Aspecto: 16:9 (Horizontal)</option>
                            <option value="4:3 aspect ratio">Aspecto: 4:3</option>
                        </select>
                    </div>
                    <button id="genPromptBtn" class="btn-primary" style="margin-top: 10px;" data-translate="btnGenPrompt">Generar Prompt</button>
                </div>

                <div class="control-group full-width">
                     <textarea id="grokPromptOutput" readonly></textarea>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- 1. Configuración y Estado ---
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        
        let currentTemplateImg = new Image();
        let backgroundImg = null;
        let isTemplateLoaded = false;

        // Definición de Áreas de Texto (Bounding Boxes) para cada plantilla
        // IMPORTANTE: Ajusta estos valores (x,y,width,height) según tus imágenes reales de template2 y 3.
        const templateConfigs = {
            'template1.png': {
                titleBox: { x: 350, y: 520, w: 900, h: 160, maxFontSize: 80 },
                descBox:  { x: 350, y: 380, w: 850, h: 100, maxFontSize: 45 }
            },
            'template2.png': { // Ejemplo: áreas diferentes
                titleBox: { x: 50, y: 600, w: 1180, h: 100, maxFontSize: 70 },
                descBox:  { x: 50, y: 500, w: 1180, h: 80,  maxFontSize: 40 }
            },
            'template3.png': { // Ejemplo: áreas diferentes
                titleBox: { x: 640, y: 550, w: 1000, h: 140, maxFontSize: 75, align: 'center' },
                descBox:  { x: 640, y: 400, w: 1000, h: 90, maxFontSize: 40, align: 'center' }
            }
        };
        let currentConfig = templateConfigs['template1.png']; // Configuración inicial

        // --- 2. Sistema de Traducción ---
        const translations = {
            es: {
                mainTitle: "Generador de Miniaturas Pro",
                lblSelectTemplate: "Seleccionar Plantilla",
                lblTitle: "1. Título Principal (Franja Inferior)",
                lblDesc: "2. Descripción (Franja Media)",
                lblBgUpload: "4. Subir Fondo Propio",
                lblGrokIdea: "3. Generador de Prompt para Grok",
                phGrokIdea: "Idea base (ej. Hacker en servidor...)",
                btnGenPrompt: "Generar Prompt",
                downloadBtn: "Descargar Miniatura",
                promptPrefix: "Crea una imagen de fondo oscura y dramática para una miniatura de YouTube. Sin texto.",
            },
            en: {
                mainTitle: "Pro Thumbnail Generator",
                lblSelectTemplate: "Select Template",
                lblTitle: "1. Main Title (Bottom Strip)",
                lblDesc: "2. Description (Middle Strip)",
                lblBgUpload: "4. Upload Your Background",
                lblGrokIdea: "3. Grok Prompt Generator",
                phGrokIdea: "Base idea (e.g., Hacker in server room...)",
                btnGenPrompt: "Generate Prompt",
                downloadBtn: "Download Thumbnail",
                promptPrefix: "Create a dark, dramatic background image for a YouTube thumbnail. No text.",
            },
            de: {
                mainTitle: "Pro Thumbnail Generator",
                lblSelectTemplate: "Vorlage auswählen",
                lblTitle: "1. Haupttitel (Unterer Streifen)",
                lblDesc: "2. Beschreibung (Mittlerer Streifen)",
                lblBgUpload: "4. Eigenen Hintergrund hochladen",
                lblGrokIdea: "3. Grok Prompt Generator",
                phGrokIdea: "Grundidee (z.B. Hacker im Serverraum...)",
                btnGenPrompt: "Prompt generieren",
                downloadBtn: "Miniaturansicht herunterladen",
                promptPrefix: "Erstellen Sie ein dunkles, dramatisches Hintergrundbild für ein YouTube-Thumbnail. Kein Text.",
            }
        };
        let currentLang = 'es';

        function setLanguage(lang) {
            currentLang = lang;
            // Actualizar botones
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');

            // Actualizar textos fijos
            document.querySelectorAll('[data-translate]').forEach(el => {
                el.textContent = translations[lang][el.dataset.translate];
            });
             // Actualizar placeholders
             document.querySelectorAll('[data-translate-ph]').forEach(el => {
                el.placeholder = translations[lang][el.dataset.translatePh];
            });
        }


        // --- 3. Funciones Principales del Canvas ---

        // Función Core: Dibuja todo
        function drawCanvas() {
            // A. Limpiar
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height);

            // B. Fondo (Usuario)
            if (backgroundImg) {
                drawCoverImage(backgroundImg);
            }

            // C. Plantilla (PNG transparente encima)
            if (isTemplateLoaded) {
                 ctx.drawImage(currentTemplateImg, 0, 0, canvas.width, canvas.height);
            }

            // D. Textos Inteligentes (Título y Descripción)
            // Usamos la configuración actual de cajas (currentConfig)
            drawSmartText(
                document.getElementById('titleText').value,
                currentConfig.titleBox,
                document.getElementById('titleFont').value,
                document.getElementById('titleColor').value,
                true // uppercase
            );
             drawSmartText(
                document.getElementById('descText').value,
                currentConfig.descBox,
                document.getElementById('descFont').value,
                document.getElementById('descColor').value,
                false // no uppercase needed for desc usually
            );
        }


        /**
         * FUNCIÓN COMPLEJA: drawSmartText
         * Mide, envuelve en líneas y ajusta el tamaño del texto para que quepa en una caja.
         */
        function drawSmartText(text, box, fontFamily, color, forceUppercase) {
            if (!text) return;
            if (forceUppercase) text = text.toUpperCase();

            let fontSize = box.maxFontSize;
            const minFontSize = 20; // Tamaño mínimo para evitar bucles infinitos
            const lineHeightMultiplier = 1.1; // Espaciado entre líneas
            let lines = [];
            
            ctx.fillStyle = color;
            ctx.textAlign = box.align || 'left'; // Soporte para alineación central si se define en config
            ctx.textBaseline = 'top';

            // Bucle de ajuste de tamaño: Reduce la fuente hasta que quepa en altura
            do {
                ctx.font = `${fontSize}px ${fontFamily}`;
                lines = wrapTextToLines(text, box.w); // Divide el texto en líneas según el ancho
                
                let totalHeight = lines.length * (fontSize * lineHeightMultiplier);
                
                // Si la altura total es menor que la caja, O si ya llegamos al tamaño mínimo, salimos.
                if (totalHeight <= box.h || fontSize <= minFontSize) {
                    break; 
                }
                // Si no cabe, reducimos la fuente y reintentamos
                fontSize -= 2;

            } while (fontSize > minFontSize);

            // --- Dibujado Final ---
            ctx.font = `${fontSize}px ${fontFamily}`; // Asegurar fuente final
            const finalLineHeight = fontSize * lineHeightMultiplier;
            const totalTextBlockHeight = lines.length * finalLineHeight;
            
            // Calcular posición Y inicial para centrar verticalmente el bloque de texto en la caja
            let startY = box.y + (box.h - totalTextBlockHeight) / 2;

            // Dibujar cada línea con un pequeño contorno para legibilidad
            lines.forEach((line, index) => {
                // Sombra/Contorno negro suave para mejorar visibilidad
                ctx.shadowColor = "rgba(0,0,0,0.8)";
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                ctx.fillText(line, box.x, startY + (index * finalLineHeight));
                
                // Resetear sombra para la siguiente iteración
                 ctx.shadowColor = "transparent";
                 ctx.shadowBlur = 0;
                 ctx.shadowOffsetX = 0;
                 ctx.shadowOffsetY = 0;
            });
        }

        // Helper para dividir texto en líneas basadas en un ancho máximo
        function wrapTextToLines(text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                let word = words[i];
                let width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // Helper para dibujar imagen de fondo cubriendo todo (object-fit: cover)
        function drawCoverImage(img) {
             const imgRatio = img.width / img.height;
             const canvasRatio = canvas.width / canvas.height;
             let renderW, renderH, offsetX, offsetY;

             if (imgRatio > canvasRatio) {
                 renderH = canvas.height;
                 renderW = img.width * (canvas.height / img.height);
                 offsetX = (canvas.width - renderW) / 2;
                 offsetY = 0;
             } else {
                 renderW = canvas.width;
                 renderH = img.height * (canvas.width / img.width);
                 offsetX = 0;
                 offsetY = (canvas.height - renderH) / 2;
             }
             ctx.drawImage(img, offsetX, offsetY, renderW, renderH);
        }


        // --- 4. Event Listeners y Lógica de UI ---

        // Carga de Plantilla
        function loadTemplate(templateFileName) {
            isTemplateLoaded = false;
            currentTemplateImg.onload = () => {
                isTemplateLoaded = true;
                // Actualizar la configuración de cajas según la plantilla elegida
                currentConfig = templateConfigs[templateFileName] || templateConfigs['template1.png'];
                drawCanvas();
            };
             currentTemplateImg.onerror = () => {
                alert("Error: No se pudo cargar " + templateFileName + ". Asegúrate de que el archivo existe.");
            };
            currentTemplateImg.src = templateFileName;
        }

        // Listener: Cambio de Plantilla
        document.getElementById('templateSelect').addEventListener('change', (e) => {
            loadTemplate(e.target.value);
        });

        // Listeners: Entradas de Texto y Color (Actualización en tiempo real)
        ['titleText', 'descText', 'titleFont', 'descFont', 'titleColor', 'descColor'].forEach(id => {
            const element = document.getElementById(id);
            // Usamos 'input' para texto y color para respuesta inmediata, 'change' para selects
            const eventType = (element.tagName === 'SELECT') ? 'change' : 'input';
            element.addEventListener(eventType, drawCanvas);
        });

        // Listener: Subida de Fondo
        document.getElementById('bgUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => { backgroundImg = img; drawCanvas(); };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Listener: Generar Prompt Grok Mejorado
        document.getElementById('genPromptBtn').addEventListener('click', () => {
            const idea = document.getElementById('grokIdea').value.trim();
            const style = document.getElementById('grokStyle').value;
            const ratio = document.getElementById('grokRatio').value;
            const prefix = translations[currentLang].promptPrefix;

            let finalPrompt = `${prefix} Style: ${style}. Aspect Ratio: ${ratio}. Description details: ${idea}`;
            if (!idea) finalPrompt += " (generic detailed background).";
            
            document.getElementById('grokPromptOutput').value = finalPrompt;
        });

        // Listener: Descargar
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'thumbnail-pro.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        });


        // --- Inicialización ---
        // Cargar la plantilla por defecto al iniciar
        setLanguage('es'); // Idioma inicial
        loadTemplate(document.getElementById('templateSelect').value);

    </script>
</body>
</html>
